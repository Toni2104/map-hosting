<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Выбор маршрута</title>
  <!-- Telegram Web App JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Яндекс.Карты (JS API). Вставьте свой YANDEX_JS_KEY. -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=2021b8f1-f2b9-48e5-acca-0c61f734e5ae"></script>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      font-family: sans-serif;
    }
    #controls {
      display: flex;
      width: 100%;
      height: 40px;
    }
    .modeBtn {
      flex: 1; 
      font-size: 14px;
      cursor: pointer;
    }
    #searchContainer {
      position: relative;
      width: 100%;
    }
    #searchInput {
      width: 100%;
      box-sizing: border-box;
      padding: 5px;
      font-size: 14px;
    }
    #suggestList {
      position: absolute;
      top: 30px;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      list-style: none;
      margin: 0;
      padding: 0;
      z-index: 9999;
    }
    #suggestList li {
      padding: 5px;
      cursor: pointer;
    }
    #suggestList li:hover {
      background: #eaeaea;
    }
    #map {
      width: 100%; 
      height: calc(100% - 90px);
    }
    #btnSubmit {
      width: 100%;
      height: 50px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Кнопки переключения режима -->
  <div id="controls">
    <button id="startBtn" class="modeBtn" style="background-color: #bde1bd;">Начальная точка</button>
    <button id="endBtn" class="modeBtn">Конечная точка</button>
  </div>

  <!-- Поле поиска + выпадающий список подсказок -->
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Введите адрес..." autocomplete="off" />
    <ul id="suggestList" style="display: none;"></ul>
  </div>

  <!-- Карта -->
  <div id="map"></div>

  <!-- Кнопка "Отправить" -->
  <button id="btnSubmit">Отправить</button>

  <script>
    const tg = window.Telegram?.WebApp || null;

    let myMap;
    let mode = "start"; // "start" или "end"
    let startPlacemark, endPlacemark;
    let startAddress = "", endAddress = "";
    let startCoords = null, endCoords = null;
    let distanceKm = 0.0;
    let multiRoute = null;

    ymaps.ready(initMap);

    function initMap() {
      myMap = new ymaps.Map("map", {
        center: [55.751574, 37.573856], // Пример: Москва
        zoom: 10
      });

      // Обработка клика по карте
      myMap.events.add('click', e => {
        const coords = e.get('coords');
        if (mode === "start") {
          setStartPoint(coords);
        } else {
          setEndPoint(coords);
        }
      });
    }

    // Установить начальную точку
    function setStartPoint(coords) {
      if (!startPlacemark) {
        startPlacemark = createPlacemark(coords, "Начало");
        myMap.geoObjects.add(startPlacemark);
      } else {
        startPlacemark.geometry.setCoordinates(coords);
      }
      startCoords = coords;
      geocodeAndSetAddress(coords, true);
      recalcRoute();
    }

    // Установить конечную точку
    function setEndPoint(coords) {
      if (!endPlacemark) {
        endPlacemark = createPlacemark(coords, "Конец");
        myMap.geoObjects.add(endPlacemark);
      } else {
        endPlacemark.geometry.setCoordinates(coords);
      }
      endCoords = coords;
      geocodeAndSetAddress(coords, false);
      recalcRoute();
    }

    function createPlacemark(coords, label) {
      return new ymaps.Placemark(coords, {
        hintContent: label
      }, {
        preset: 'islands#redDotIcon'
      });
    }

    // Геокодирование + проверка ошибок
    function geocodeAndSetAddress(coords, isStart) {
      ymaps.geocode(coords).then(res => {
        const firstGeoObject = res.geoObjects.get(0);
        if (!firstGeoObject) {
          alert("Не удалось определить адрес, попробуйте ещё раз.");
          return;
        }
        let addr = firstGeoObject.getAddressLine();
        if (isStart) {
          startAddress = addr;
        } else {
          endAddress = addr;
        }
      }).catch(err => {
        alert("Ошибка при геокодировании: " + err);
      });
    }

    // Перерасчёт маршрута
    function recalcRoute() {
      if (!startCoords || !endCoords) return;

      if (multiRoute) {
        myMap.geoObjects.remove(multiRoute);
      }

      multiRoute = new ymaps.multiRouter.MultiRoute({
        referencePoints: [startCoords, endCoords],
        params: { routingMode: 'auto' }
      }, {
        boundsAutoApply: true
      });

      multiRoute.model.events.add('requestsuccess', () => {
        const activeRoute = multiRoute.getActiveRoute();
        if (activeRoute) {
          const distance = activeRoute.properties.get('distance').value; // метры
          distanceKm = distance / 1000;
        }
      });

      myMap.geoObjects.add(multiRoute);
    }

    // Кнопки режима
    const startBtn = document.getElementById("startBtn");
    const endBtn = document.getElementById("endBtn");

    startBtn.addEventListener("click", () => {
      mode = "start";
      startBtn.style.backgroundColor = "#bde1bd";
      endBtn.style.backgroundColor = "";
    });
    endBtn.addEventListener("click", () => {
      mode = "end";
      endBtn.style.backgroundColor = "#bde1bd";
      startBtn.style.backgroundColor = "";
    });

    // Поле поиска + подсказки
    const searchInput = document.getElementById("searchInput");
    const suggestList = document.getElementById("suggestList");
    let suggestTimer;

    searchInput.addEventListener("input", () => {
      clearTimeout(suggestTimer);
      let query = searchInput.value.trim();
      if (query.length >= 3) {
        suggestTimer = setTimeout(() => {
          ymaps.suggest(query).then(items => {
            // Очищаем список
            suggestList.innerHTML = "";
            if (items.length > 0) {
              items.forEach(sug => {
                const li = document.createElement("li");
                li.textContent = sug.displayName || sug.value;
                li.addEventListener("click", () => {
                  searchInput.value = sug.value;
                  suggestList.style.display = "none";
                  // Геокодим и ставим точку
                  setAddressByGeocode(sug.value);
                });
                suggestList.appendChild(li);
              });
              suggestList.style.display = "block";
            } else {
              suggestList.style.display = "none";
            }
          }).catch(err => {
            console.log("Suggest error:", err);
          });
        }, 400);
      } else {
        suggestList.style.display = "none";
      }
    });

    // При клике вне списка — скрываем
    document.addEventListener("click", (e) => {
      if (!searchContainerContains(e.target)) {
        suggestList.style.display = "none";
      }
    });
    function searchContainerContains(target) {
      return (target === searchInput || target === suggestList || suggestList.contains(target));
    }

    function setAddressByGeocode(address) {
      ymaps.geocode(address).then(res => {
        const obj = res.geoObjects.get(0);
        if (!obj) {
          alert("Адрес не найден, попробуйте скорректировать ввод.");
          return;
        }
        const coords = obj.geometry.getCoordinates();
        if (mode === "start") {
          setStartPoint(coords);
        } else {
          setEndPoint(coords);
        }
      }).catch(err => {
        alert("Ошибка при геокодировании: " + err);
      });
    }

    // Кнопка "Отправить"
    const btnSubmit = document.getElementById("btnSubmit");
    btnSubmit.addEventListener("click", () => {
      if (!startAddress || !endAddress) {
        alert("Укажите начальный и конечный адрес.");
        return;
      }
      if (!tg) {
        alert("Открыто не в Telegram WebView!");
        return;
      }

      // Генерируем ссылку на маршрут (но пользователю её не показываем).
      let routeLink = "";
      if (startCoords && endCoords) {
        // Проверяйте порядок lat/lon. Обычно Yandex Maps URL: lat,lon
        routeLink = `https://yandex.ru/maps/?rtext=${startCoords[0]},${startCoords[1]}~${endCoords[0]},${endCoords[1]}&rtt=auto`;
      }

      const dataToSend = {
        start_address: startAddress,
        end_address: endAddress,
        distance_km: +distanceKm.toFixed(2),
        route_link: routeLink
      };

      tg.sendData(JSON.stringify(dataToSend));
      tg.close();
    });
  </script>
</body>
</html>
