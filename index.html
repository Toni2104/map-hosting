<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Выбор маршрута</title>
  <!-- Telegram Web App JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Яндекс.Карты (JS API). Вставьте свой YANDEX_JS_KEY. -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=2021b8f1-f2b9-48e5-acca-0c61f734e5ae"></script>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      font-family: sans-serif;
    }
    #controls {
      display: flex;
      width: 100%;
      height: 50px;
    }
    .modeBtn {
      flex: 1; 
      font-size: 16px;
      cursor: pointer;
    }
    #map {
      width: 100%; 
      height: calc(100% - 100px);
    }
    #submitRow {
      display: flex;
      width: 100%;
      height: 50px;
    }
    #btnSubmit {
      flex: 1;
      font-size: 16px;
      cursor: pointer;
    }
    #searchInput {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Кнопки переключения режима -->
  <div id="controls">
    <button id="startBtn" class="modeBtn" style="background-color: #bde1bd;">Начальная точка</button>
    <button id="endBtn" class="modeBtn">Конечная точка</button>
  </div>

  <!-- Поле поиска адреса (автодополнение) -->
  <input type="text" id="searchInput" placeholder="Введите адрес..." />

  <!-- Карта -->
  <div id="map"></div>

  <!-- Кнопка "Отправить" -->
  <div id="submitRow">
    <button id="btnSubmit">Отправить</button>
  </div>

  <script>
    const tg = window.Telegram?.WebApp || null;

    let myMap;
    let mode = "start"; // "start" или "end"
    let startPlacemark, endPlacemark;
    let startAddress = "", endAddress = "";
    let startCoords = null, endCoords = null;
    let distanceKm = 0.0;
    let multiRoute = null;

    // При загрузке Яндекс API инициализируем карту
    ymaps.ready(initMap);

    function initMap() {
      myMap = new ymaps.Map("map", {
        center: [55.751574, 37.573856], // Пример: Москва
        zoom: 10
      });

      // Обработка клика по карте
      myMap.events.add('click', e => {
        const coords = e.get('coords');
        if (mode === "start") {
          setStartPoint(coords);
        } else {
          setEndPoint(coords);
        }
      });
    }

    // Установить/обновить начальную точку
    function setStartPoint(coords) {
      if (!startPlacemark) {
        startPlacemark = createPlacemark(coords, "Начало");
        myMap.geoObjects.add(startPlacemark);
      } else {
        startPlacemark.geometry.setCoordinates(coords);
      }
      startCoords = coords;
      getAddress(coords, true);
      recalcRoute();
    }

    // Установить/обновить конечную точку
    function setEndPoint(coords) {
      if (!endPlacemark) {
        endPlacemark = createPlacemark(coords, "Конец");
        myMap.geoObjects.add(endPlacemark);
      } else {
        endPlacemark.geometry.setCoordinates(coords);
      }
      endCoords = coords;
      getAddress(coords, false);
      recalcRoute();
    }

    function createPlacemark(coords, label) {
      return new ymaps.Placemark(coords, {
        hintContent: label
      }, {
        preset: 'islands#redDotIcon'
      });
    }

    // Получаем адрес через геокодер
    function getAddress(coords, isStart) {
      ymaps.geocode(coords).then(res => {
        let firstGeoObject = res.geoObjects.get(0);
        let addr = firstGeoObject.getAddressLine();
        if (isStart) {
          startAddress = addr;
        } else {
          endAddress = addr;
        }
      });
    }

    // Пересчитываем маршрут, если есть обе точки
    function recalcRoute() {
      if (!startCoords || !endCoords) return;

      // Удаляем предыдущий маршрут
      if (multiRoute) {
        myMap.geoObjects.remove(multiRoute);
      }

      multiRoute = new ymaps.multiRouter.MultiRoute({
        referencePoints: [startCoords, endCoords],
        params: { routingMode: 'auto' }
      }, {
        boundsAutoApply: true
      });

      multiRoute.model.events.add('requestsuccess', () => {
        const activeRoute = multiRoute.getActiveRoute();
        if (activeRoute) {
          const distance = activeRoute.properties.get('distance').value; // метры
          distanceKm = distance / 1000;
        }
      });

      myMap.geoObjects.add(multiRoute);
    }

    // Кнопки переключения режима
    const startBtn = document.getElementById("startBtn");
    const endBtn = document.getElementById("endBtn");

    startBtn.addEventListener("click", () => {
      mode = "start";
      startBtn.style.backgroundColor = "#bde1bd";
      endBtn.style.backgroundColor = "";
    });

    endBtn.addEventListener("click", () => {
      mode = "end";
      endBtn.style.backgroundColor = "#bde1bd";
      startBtn.style.backgroundColor = "";
    });

    // Обработка поля поиска (автодополнение, упрощённый вариант)
    const searchInput = document.getElementById("searchInput");
    let suggestTimer;
    searchInput.addEventListener("input", () => {
      clearTimeout(suggestTimer);
      let query = searchInput.value.trim();
      if (query.length > 2) {
        suggestTimer = setTimeout(() => {
          // Используем ymaps.suggest
          ymaps.suggest(query).then(items => {
            // Можно показывать выпадающий список, в упрощённом виде
            // здесь просто берём первый ответ
            if (items.length > 0) {
              // Берём первый вариант, геокодим и ставим точку
              let suggestion = items[0].value;
              // Можно дополнительно отобразить выпадайку, 
              // тут для простоты сразу ставим точку
              setAddressByGeocode(suggestion);
            }
          });
        }, 500);
      }
    });

    function setAddressByGeocode(address) {
      ymaps.geocode(address).then(res => {
        let obj = res.geoObjects.get(0);
        if (obj) {
          let coords = obj.geometry.getCoordinates();
          if (mode === "start") {
            setStartPoint(coords);
          } else {
            setEndPoint(coords);
          }
        }
      });
    }

    // Кнопка "Отправить"
    document.getElementById("btnSubmit").addEventListener("click", () => {
      if (!startAddress || !endAddress) {
        alert("Сначала укажите начальную и конечную точки (кликами по карте или поиском).");
        return;
      }
      if (!tg) {
        alert("Telegram WebApp не обнаружен!");
        return;
      }
      // Формируем ссылку для курьера
      let routeLink = "";
      if (startCoords && endCoords) {
        // Yandex Maps URL: https://yandex.ru/maps/?rtext=<lat1>,<lon1>~<lat2>,<lon2>&rtt=auto
        // НО в geocoder/route координаты [lat, lon], а в URL [lat,lon], тут всё совпадает
        // Иногда надо местами менять lat/lon, проверяйте формат
        routeLink = `https://yandex.ru/maps/?rtext=${startCoords[0]},${startCoords[1]}~${endCoords[0]},${endCoords[1]}&rtt=auto`;
      }

      const dataToSend = {
        start_address: startAddress,
        end_address: endAddress,
        distance_km: Number(distanceKm.toFixed(2)),
        route_link: routeLink
      };

      tg.sendData(JSON.stringify(dataToSend));
      // Закрываем окно (по желанию)
      tg.close();
    });
  </script>
</body>
</html>
