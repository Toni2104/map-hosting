<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Выбор маршрута</title>
  <script>
    // Проверка на Telegram WebApp
    const tg = (typeof window.Telegram !== 'undefined') ? window.Telegram.WebApp : null;
    if (tg) {
      tg.expand();
    }
  </script>
  <!-- Подключаем Яндекс.Карты 2.1 (или 3.0, но пример для 2.1) -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=2021b8f1-f2b9-48e5-acca-0c61f734e5ae&lang=ru_RU"></script>
  <style>
    #map { width: 100%; height: 60vh; }
    body { margin: 0; font-family: sans-serif; }
    .controls { display: flex; gap: 10px; padding: 10px; }
    button { padding: 8px; }
  </style>
</head>
<body>
  <div class="controls">
    <button id="modeA" data-mode="A">Выбираю точку А</button>
    <button id="modeB" data-mode="B">Выбираю точку Б</button>
    <button id="buildRoute">Построить маршрут</button>
    <button id="btnDone">Готово</button>
  </div>
  <div id="map"></div>

  <script>
    let mode = 'A'; // По умолчанию ставим A
    let placemarkA, placemarkB, route;
    let map;
    ymaps.ready(init);

    function init() {
      map = new ymaps.Map("map", {
        center: [55.751244, 37.618423],
        zoom: 10
      });

      // При клике на карту ставим/переставляем A или B
      map.events.add('click', e => {
        const coords = e.get('coords');
        setPlacemark(coords, mode);
      });

      // Привязываем кнопки "Выбираю точку А/В"
      document.getElementById('modeA').addEventListener('click', () => mode = 'A');
      document.getElementById('modeB').addEventListener('click', () => mode = 'B');

      // Кнопка "Построить маршрут"
      document.getElementById('buildRoute').addEventListener('click', () => {
        buildRoute();
      });

      // Кнопка "Готово"
      document.getElementById('btnDone').addEventListener('click', () => {
        if(!placemarkA || !placemarkB) {
          alert("Нужно выбрать обе точки A и B.");
          return;
        }
        const coordsA = placemarkA.geometry.getCoordinates();
        const coordsB = placemarkB.geometry.getCoordinates();
        const data = {
          start: { lat: coordsA[0], lon: coordsA[1] },
          end:   { lat: coordsB[0], lon: coordsB[1] }
        };
        // Отправляем в Telegram
        if (tg) {
          tg.sendData(JSON.stringify(data));
        } else {
          alert("Данные (A,B) отправлены: " + JSON.stringify(data));
        }
      });
    }

    function setPlacemark(coords, label) {
      if (label === 'A') {
        if (!placemarkA) {
          placemarkA = createPlacemark(coords, 'A', 'islands#redIcon');
          map.geoObjects.add(placemarkA);
        } else {
          placemarkA.geometry.setCoordinates(coords);
        }
      } else {
        if (!placemarkB) {
          placemarkB = createPlacemark(coords, 'B', 'islands#blueIcon');
          map.geoObjects.add(placemarkB);
        } else {
          placemarkB.geometry.setCoordinates(coords);
        }
      }
    }

    function createPlacemark(coords, text, preset) {
      return new ymaps.Placemark(coords, {
        iconContent: text
      }, {
        preset: preset,
        draggable: true
      });
    }

    // Построение маршрута через ymaps.route
    function buildRoute() {
      if (route) {
        map.geoObjects.remove(route);
        route = null;
      }
      if (placemarkA && placemarkB) {
        const coordsA = placemarkA.geometry.getCoordinates();
        const coordsB = placemarkB.geometry.getCoordinates();
        ymaps.route([coordsA, coordsB])
          .then(function(res) {
            route = res;
            map.geoObjects.add(route);
            // Можно при желании подогнать масштаб
            map.setBounds(route.getBounds(), { checkZoomRange: true });
          })
          .catch(err => {
            console.error("Не удалось построить маршрут", err);
          });
      } else {
        alert("Сначала выберите обе точки A и B!");
      }
    }
  </script>
</body>
</html>
